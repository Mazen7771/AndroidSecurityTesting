# src/modules/exploitation_tools.py
"""
Advanced Android Exploitation & Security Analysis Toolkit
"""

import sys
import os
import hashlib
import json
import time
from datetime import datetime
import threading
from pathlib import Path

# Try to import required libraries
try:
    from PyQt5.QtWidgets import (
        QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, 
        QProgressBar, QTextEdit, QFileDialog, QListWidget, 
        QListWidgetItem, QGroupBox, QMessageBox, QLineEdit,
        QTabWidget, QFrame, QSplitter, QComboBox, QScrollArea
    )
    from PyQt5.QtCore import Qt, pyqtSignal, QObject
    from PyQt5.QtGui import QColor
    PYQT5_AVAILABLE = True
except ImportError:
    PYQT5_AVAILABLE = False
    print("Warning: PyQt5 not available. GUI features will be limited.")

try:
    import requests
    REQUESTS_AVAILABLE = True
except ImportError:
    REQUESTS_AVAILABLE = False
    print("Warning: requests module not available. Online features will be limited.")

# Handle qtawesome import gracefully
QTA_AVAILABLE = False
try:
    import qtawesome as qta
    QTA_AVAILABLE = True
except ImportError:
    print("Warning: qtawesome not available. Using text labels instead of icons.")
    # Create a mock qta object for compatibility
    class MockQta:
        @staticmethod
        def icon(name, **kwargs):
            return None
    qta = MockQta()

class WorkerSignals(QObject):
    """Signals for communicating with the main thread"""
    finished = pyqtSignal()
    progress = pyqtSignal(int)
    result = pyqtSignal(object)
    error = pyqtSignal(str)

class VirusScannerWorker(threading.Thread):
    """Worker thread for virus scanning operations"""
    def __init__(self, file_path, api_key=None):
        super().__init__()
        self.file_path = file_path
        self.api_key = api_key
        self.signals = WorkerSignals()
        
    def run(self):
        try:
            # Scan file locally first
            self.signals.progress.emit(10)
            
            # Calculate file hash
            file_hash = self.calculate_hash(self.file_path)
            self.signals.progress.emit(30)
            
            # Check against local signatures (simplified)
            is_malicious = self.check_local_signatures(file_hash)
            self.signals.progress.emit(50)
            
            # If VirusTotal API key provided, check online
            vt_result = None
            if self.api_key and REQUESTS_AVAILABLE:
                vt_result = self.check_virustotal(file_hash, self.api_key)
                self.signals.progress.emit(80)
            
            result = {
                'file_path': self.file_path,
                'hash': file_hash,
                'is_malicious': is_malicious,
                'vt_result': vt_result,
                'scan_time': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }
            
            self.signals.progress.emit(100)
            self.signals.result.emit(result)
        except Exception as e:
            self.signals.error.emit(str(e))
        finally:
            self.signals.finished.emit()
    
    def calculate_hash(self, file_path):
        """Calculate SHA256 hash of file"""
        sha256_hash = hashlib.sha256()
        with open(file_path, "rb") as f:
            for byte_block in iter(lambda: f.read(4096), b""):
                sha256_hash.update(byte_block)
        return sha256_hash.hexdigest()
    
    def check_local_signatures(self, file_hash):
        """Check file hash against local malware signatures"""
        # This is a simplified check - in practice you'd have a larger signature database
        known_malware_hashes = [
            "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",  # Example hash
            # Add more known malware hashes here
        ]
        return file_hash in known_malware_hashes
    
    def check_virustotal(self, file_hash, api_key):
        """Check file hash against VirusTotal database"""
        try:
            if not REQUESTS_AVAILABLE:
                return {'error': 'Requests library not available'}
                
            headers = {
                'x-apikey': api_key,
                'Accept': 'application/json'
            }
            
            url = f'https://www.virustotal.com/api/v3/files/{file_hash}'
            response = requests.get(url, headers=headers)
            
            if response.status_code == 200:
                data = response.json()
                attributes = data['data']['attributes']
                stats = attributes['last_analysis_stats']
                malicious_count = stats['malicious']
                total_engines = sum(stats.values())
                
                return {
                    'malicious': malicious_count > 0,
                    'malicious_count': malicious_count,
                    'total_engines': total_engines,
                    'permalink': f"https://www.virustotal.com/gui/file/{file_hash}"
                }
            else:
                return {'error': f'API request failed with status {response.status_code}'}
        except Exception as e:
            return {'error': str(e)}

class AndroidAnalyzer:
    """Simplified Android APK analyzer"""
    def __init__(self):
        pass
    
    def analyze_apk(self, apk_path):
        """Perform basic APK analysis"""
        try:
            # For now, just return basic file info since androguard isn't available
            result = {
                'package_name': 'Unknown (androguard not installed)',
                'app_name': os.path.basename(apk_path),
                'permissions': ['Analysis limited without androguard'],
                'suspicious_permissions': [],
                'activities': ['Analysis limited without androguard'],
                'services': ['Analysis limited without androguard'],
                'receivers': ['Analysis limited without androguard'],
                'analysis_time': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }
            return result
        except Exception as e:
            return {'error': str(e)}

class ExploitationToolsGUI(QWidget):
    def __init__(self):
        super().__init__()
        # Initialize attributes before calling init_ui
        self.virustotal_api_key = None
        self.scan_results = []
        self.analysis_results = []
        self.selected_file = None
        self.selected_apk = None
        
        self.init_ui()
        self.load_settings()
    
    def init_ui(self):
        """Initialize the user interface"""
        layout = QVBoxLayout(self)
        
        # Create tabbed interface within the widget
        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)
        
        # Create tabs
        self.create_scanner_tab()
        self.create_android_analysis_tab()
        self.create_results_tab()
        self.create_settings_tab()
    
    def create_scanner_tab(self):
        """Create virus scanner tab"""
        scanner_tab = QWidget()
        layout = QVBoxLayout(scanner_tab)
        
        # File selection section
        file_group = QGroupBox("File Selection")
        file_layout = QHBoxLayout(file_group)
        
        self.file_path_label = QLabel("No file selected")
        self.file_path_label.setWordWrap(True)
        file_layout.addWidget(self.file_path_label)
        
        # Use text labels instead of icons if qtawesome is not available
        select_btn_text = "Select File" if not QTA_AVAILABLE else "üìÇ Select File"
        select_btn = QPushButton(select_btn_text)
        select_btn.clicked.connect(self.open_file_dialog)
        file_layout.addWidget(select_btn)
        
        layout.addWidget(file_group)
        
        # Scan controls
        controls_group = QGroupBox("Scan Controls")
        controls_layout = QHBoxLayout(controls_group)
        
        scan_btn_text = "Scan File" if not QTA_AVAILABLE else "üîç Scan File"
        self.scan_btn = QPushButton(scan_btn_text)
        self.scan_btn.clicked.connect(self.scan_selected_file)
        self.scan_btn.setEnabled(False)
        controls_layout.addWidget(self.scan_btn)
        
        self.scan_progress = QProgressBar()
        self.scan_progress.setVisible(False)
        controls_layout.addWidget(self.scan_progress)
        
        layout.addWidget(controls_group)
        
        # Results display
        results_group = QGroupBox("Scan Results")
        results_layout = QVBoxLayout(results_group)
        
        self.scan_output = QTextEdit()
        self.scan_output.setReadOnly(True)
        results_layout.addWidget(self.scan_output)
        
        layout.addWidget(results_group)
        
        tab_text = "Virus Scanner" if not QTA_AVAILABLE else "üîç Virus Scanner"
        self.tabs.addTab(scanner_tab, tab_text)
    
    def create_android_analysis_tab(self):
        """Create Android APK analysis tab"""
        android_tab = QWidget()
        layout = QVBoxLayout(android_tab)
        
        # APK selection section
        apk_group = QGroupBox("APK Selection")
        apk_layout = QHBoxLayout(apk_group)
        
        self.apk_path_label = QLabel("No APK selected")
        self.apk_path_label.setWordWrap(True)
        apk_layout.addWidget(self.apk_path_label)
        
        select_btn_text = "Select APK" if not QTA_AVAILABLE else "ü§ñ Select APK"
        select_btn = QPushButton(select_btn_text)
        select_btn.clicked.connect(self.open_apk_dialog)
        apk_layout.addWidget(select_btn)
        
        layout.addWidget(apk_group)
        
        # Analysis controls
        controls_group = QGroupBox("Analysis Controls")
        controls_layout = QHBoxLayout(controls_group)
        
        analyze_btn_text = "Analyze APK" if not QTA_AVAILABLE else "ü§ñ Analyze APK"
        self.analyze_btn = QPushButton(analyze_btn_text)
        self.analyze_btn.clicked.connect(self.analyze_selected_apk)
        self.analyze_btn.setEnabled(False)
        controls_layout.addWidget(self.analyze_btn)
        
        self.analysis_progress = QProgressBar()
        self.analysis_progress.setVisible(False)
        controls_layout.addWidget(self.analysis_progress)
        
        layout.addWidget(controls_group)
        
        # Results display
        results_group = QGroupBox("Analysis Results")
        results_layout = QVBoxLayout(results_group)
        
        self.analysis_output = QTextEdit()
        self.analysis_output.setReadOnly(True)
        results_layout.addWidget(self.analysis_output)
        
        layout.addWidget(results_group)
        
        tab_text = "Android Analyzer" if not QTA_AVAILABLE else "ü§ñ Android Analyzer"
        self.tabs.addTab(android_tab, tab_text)
    
    def create_results_tab(self):
        """Create results tab with history"""
        results_tab = QWidget()
        layout = QVBoxLayout(results_tab)
        
        # History list
        history_group = QGroupBox("Scan History")
        history_layout = QVBoxLayout(history_group)
        
        self.history_list = QListWidget()
        self.history_list.itemClicked.connect(self.show_history_item)
        history_layout.addWidget(self.history_list)
        
        # Actions
        actions_layout = QHBoxLayout()
        clear_btn_text = "Clear History" if not QTA_AVAILABLE else "üóëÔ∏è Clear History"
        clear_btn = QPushButton(clear_btn_text)
        export_btn_text = "Export Results" if not QTA_AVAILABLE else "üíæ Export Results"
        export_btn = QPushButton(export_btn_text)
        clear_btn.clicked.connect(self.clear_history)
        export_btn.clicked.connect(self.export_results)
        actions_layout.addWidget(clear_btn)
        actions_layout.addWidget(export_btn)
        
        history_layout.addLayout(actions_layout)
        
        layout.addWidget(history_group)
        
        # Detailed results
        detail_group = QGroupBox("Detailed Results")
        detail_layout = QVBoxLayout(detail_group)
        
        self.detail_output = QTextEdit()
        self.detail_output.setReadOnly(True)
        detail_layout.addWidget(self.detail_output)
        
        layout.addWidget(detail_group)
        
        tab_text = "Results" if not QTA_AVAILABLE else "üìä Results"
        self.tabs.addTab(results_tab, tab_text)
    
    def create_settings_tab(self):
        """Create settings tab"""
        settings_tab = QWidget()
        layout = QVBoxLayout(settings_tab)
        
        # API Settings
        api_group = QGroupBox("API Settings")
        api_layout = QVBoxLayout(api_group)
        
        api_layout.addWidget(QLabel("VirusTotal API Key:"))
        self.api_key_input = QLineEdit()
        self.api_key_input.setEchoMode(QLineEdit.Password)
        if self.virustotal_api_key:
            self.api_key_input.setText(self.virustotal_api_key)
        api_layout.addWidget(self.api_key_input)
        
        save_btn_text = "Save Settings" if not QTA_AVAILABLE else "üíæ Save Settings"
        save_btn = QPushButton(save_btn_text)
        save_btn.clicked.connect(self.save_settings)
        api_layout.addWidget(save_btn)
        
        api_layout.addStretch()
        layout.addWidget(api_group)
        
        # Tool Information
        info_group = QGroupBox("Tool Information")
        info_layout = QVBoxLayout(info_group)
        
        info_text = QLabel("""
        <h3>Android Security Analysis Toolkit</h3>
        <p><b>Features:</b></p>
        <ul>
            <li>Virus/Malware detection with local analysis</li>
            <li>Android APK analysis (requires androguard for full features)</li>
            <li>Integration with VirusTotal database (API key required)</li>
            <li>Detailed reporting and export capabilities</li>
        </ul>
        <p><b>Note:</b> For full functionality:
        <ul>
            <li>Install androguard: pip install androguard</li>
            <li>Get VirusTotal API key from virustotal.com</li>
        </ul>
        </p>
        """)
        info_text.setWordWrap(True)
        info_text.setOpenExternalLinks(True)
        info_layout.addWidget(info_text)
        
        layout.addWidget(info_group)
        layout.addStretch()
        
        tab_text = "Settings" if not QTA_AVAILABLE else "‚öôÔ∏è Settings"
        self.tabs.addTab(settings_tab, tab_text)
    
    def open_file_dialog(self):
        """Open file dialog for virus scanning"""
        file_path, _ = QFileDialog.getOpenFileName(
            self, "Select File to Scan", "", 
            "All Files (*.*)"
        )
        
        if file_path:
            self.file_path_label.setText(file_path)
            self.scan_btn.setEnabled(True)
            self.selected_file = file_path
    
    def open_apk_dialog(self):
        """Open APK file dialog for analysis"""
        apk_path, _ = QFileDialog.getOpenFileName(
            self, "Select APK File", "", 
            "APK Files (*.apk)"
        )
        
        if apk_path:
            self.apk_path_label.setText(apk_path)
            self.analyze_btn.setEnabled(True)
            self.selected_apk = apk_path
    
    def scan_selected_file(self):
        """Start scanning the selected file"""
        if not hasattr(self, 'selected_file') or not self.selected_file:
            QMessageBox.warning(self, "No File Selected", "Please select a file to scan.")
            return
        
        # Disable UI elements during scan
        self.scan_btn.setEnabled(False)
        self.scan_progress.setVisible(True)
        self.scan_progress.setValue(0)
        self.scan_output.clear()
        
        # Start scanning in separate thread
        self.scanner_worker = VirusScannerWorker(
            self.selected_file, 
            self.virustotal_api_key
        )
        self.scanner_worker.signals.progress.connect(self.update_scan_progress)
        self.scanner_worker.signals.result.connect(self.scan_completed)
        self.scanner_worker.signals.error.connect(self.scan_error)
        self.scanner_worker.start()
    
    def update_scan_progress(self, value):
        """Update scan progress bar"""
        self.scan_progress.setValue(value)
    
    def scan_completed(self, result):
        """Handle completed scan"""
        self.scan_btn.setEnabled(True)
        self.scan_progress.setVisible(False)
        
        # Format and display results
        output = f"Scan completed at: {result['scan_time']}\n"
        output += f"File: {os.path.basename(result['file_path'])}\n"
        output += f"SHA256: {result['hash']}\n\n"
        
        if result['is_malicious']:
            output += "üî¥ MALICIOUS FILE DETECTED!\n"
            output += "‚ö†Ô∏è  This file matches known malware signatures.\n\n"
        else:
            output += "üü¢ No local signatures matched.\n\n"
        
        if result['vt_result']:
            if 'error' in result['vt_result']:
                output += f"VirusTotal Error: {result['vt_result']['error']}\n"
            else:
                vt_result = result['vt_result']
                if vt_result['malicious']:
                    output += f"üî¥ VirusTotal: {vt_result['malicious_count']}/{vt_result['total_engines']} engines detected this as malicious.\n"
                    output += f"View report: {vt_result['permalink']}\n"
                else:
                    output += f"üü¢ VirusTotal: No threats detected by {vt_result['total_engines']} engines.\n"
        elif self.virustotal_api_key:
            output += "VirusTotal: API key provided but scan failed.\n"
        else:
            output += "VirusTotal: No API key provided. Add one in Settings for cloud scanning.\n"
        
        self.scan_output.setPlainText(output)
        
        # Save to history
        self.scan_results.append(result)
        self.update_history_list()
    
    def scan_error(self, error_msg):
        """Handle scan error"""
        self.scan_btn.setEnabled(True)
        self.scan_progress.setVisible(False)
        QMessageBox.critical(self, "Scan Error", f"An error occurred during scanning:\n{error_msg}")
    
    def analyze_selected_apk(self):
        """Start analyzing the selected APK"""
        if not hasattr(self, 'selected_apk') or not self.selected_apk:
            QMessageBox.warning(self, "No APK Selected", "Please select an APK file to analyze.")
            return
        
        # Disable UI elements during analysis
        self.analyze_btn.setEnabled(False)
        self.analysis_progress.setVisible(True)
        self.analysis_progress.setValue(0)
        self.analysis_output.clear()
        
        # Perform analysis
        try:
            analyzer = AndroidAnalyzer()
            result = analyzer.analyze_apk(self.selected_apk)
            
            # Update UI
            self.analyze_btn.setEnabled(True)
            self.analysis_progress.setVisible(False)
            
            if 'error' in result:
                self.analysis_output.setPlainText(f"Error during analysis: {result['error']}")
                return
            
            # Format and display results
            output = f"Analysis completed at: {result['analysis_time']}\n"
            output += f"App Name: {result['app_name']}\n"
            output += f"Package: {result['package_name']}\n\n"
            
            output += "üîç PERMISSIONS ANALYSIS:\n"
            if result['suspicious_permissions']:
                output += "‚ö†Ô∏è  Suspicious permissions detected:\n"
                for perm in result['suspicious_permissions']:
                    output += f"  - {perm}\n"
            else:
                output += "üü¢ No suspicious permissions found.\n"
            
            output += f"\nüìã PERMISSIONS ({len(result['permissions'])} total):\n"
            for perm in result['permissions'][:15]:  # Limit for display
                output += f"  - {perm}\n"
            if len(result['permissions']) > 15:
                output += f"  ... and {len(result['permissions']) - 15} more\n"
            
            output += f"\nüéÆ ACTIVITIES ({len(result['activities'])} listed):\n"
            for activity in result['activities']:
                output += f"  - {activity}\n"
            
            output += f"\nüîß SERVICES ({len(result['services'])} listed):\n"
            for service in result['services']:
                output += f"  - {service}\n"
            
            self.analysis_output.setPlainText(output)
            
            # Save to history
            self.analysis_results.append(result)
            self.update_history_list()
            
        except Exception as e:
            self.analyze_btn.setEnabled(True)
            self.analysis_progress.setVisible(False)
            QMessageBox.critical(self, "Analysis Error", f"An error occurred during analysis:\n{str(e)}")
    
    def update_history_list(self):
        """Update history list with scan and analysis results"""
        self.history_list.clear()
        
        # Add scan results
        for result in self.scan_results[-10:]:  # Show last 10
            item_text = f"[SCAN] {os.path.basename(result['file_path'])} - {result['scan_time']}"
            item = QListWidgetItem(item_text)
            item.setData(Qt.UserRole, result)
            if result['is_malicious']:
                item.setForeground(QColor('red'))
            else:
                item.setForeground(QColor('green'))
            self.history_list.addItem(item)
        
        # Add analysis results
        for result in self.analysis_results[-10:]:  # Show last 10
            item_text = f"[APK] {result['app_name']} - {result['analysis_time']}"
            item = QListWidgetItem(item_text)
            item.setData(Qt.UserRole, result)
            if result['suspicious_permissions']:
                item.setForeground(QColor('orange'))
            else:
                item.setForeground(QColor('green'))
            self.history_list.addItem(item)
    
    def show_history_item(self, item):
        """Show details of selected history item"""
        data = item.data(Qt.UserRole)
        if not data:
            return
            
        # Format detailed output based on data type
        if 'file_path' in data:  # Scan result
            output = f"=== VIRUS SCAN RESULT ===\n"
            output += f"File: {data['file_path']}\n"
            output += f"SHA256: {data['hash']}\n"
            output += f"Scan Time: {data['scan_time']}\n\n"
            
            if data['is_malicious']:
                output += "üî¥ MALICIOUS FILE DETECTED!\n"
            else:
                output += "üü¢ No local signatures matched.\n"
            
            if data['vt_result']:
                if 'error' in data['vt_result']:
                    output += f"\nVirusTotal Error: {data['vt_result']['error']}\n"
                else:
                    vt_result = data['vt_result']
                    output += f"\n=== VIRUS TOTAL RESULTS ===\n"
                    if vt_result['malicious']:
                        output += f"üî¥ {vt_result['malicious_count']}/{vt_result['total_engines']} engines detected this as malicious.\n"
                        output += f"Report: {vt_result['permalink']}\n"
                    else:
                        output += f"üü¢ No threats detected by {vt_result['total_engines']} engines.\n"
            
        elif 'package_name' in data:  # Analysis result
            output = f"=== ANDROID APK ANALYSIS ===\n"
            output += f"App Name: {data['app_name']}\n"
            output += f"Package: {data['package_name']}\n"
            output += f"Analysis Time: {data['analysis_time']}\n\n"
            
            output += "üîç PERMISSIONS ANALYSIS:\n"
            if data['suspicious_permissions']:
                output += "‚ö†Ô∏è  Suspicious permissions detected:\n"
                for perm in data['suspicious_permissions']:
                    output += f"  - {perm}\n"
            else:
                output += "üü¢ No suspicious permissions found.\n"
            
            output += f"\nüìã ALL PERMISSIONS:\n"
            for perm in data['permissions']:
                output += f"  - {perm}\n"
            
            output += f"\nüéÆ ACTIVITIES:\n"
            for activity in data['activities']:
                output += f"  - {activity}\n"
            
            output += f"\nüîß SERVICES:\n"
            for service in data['services']:
                output += f"  - {service}\n"
            
            output += f"\nüì° RECEIVERS:\n"
            for receiver in data['receivers']:
                output += f"  - {receiver}\n"
        
        self.detail_output.setPlainText(output)
    
    def clear_history(self):
        """Clear scan and analysis history"""
        self.scan_results.clear()
        self.analysis_results.clear()
        self.history_list.clear()
        self.detail_output.clear()
        QMessageBox.information(self, "History Cleared", "Scan history has been cleared.")
    
    def export_results(self):
        """Export results to file"""
        if not self.scan_results and not self.analysis_results:
            QMessageBox.warning(self, "No Data", "No results to export.")
            return
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, "Export Results", "security_analysis_results.txt", 
            "Text Files (*.txt);;JSON Files (*.json);;All Files (*.*)"
        )
        
        if file_path:
            try:
                # Determine export format based on extension
                if file_path.endswith('.json'):
                    data = {
                        'scan_results': self.scan_results,
                        'analysis_results': self.analysis_results,
                        'export_time': datetime.now().isoformat()
                    }
                    with open(file_path, 'w') as f:
                        json.dump(data, f, indent=2)
                else:
                    # Text format
                    with open(file_path, 'w') as f:
                        f.write("Android Security Analysis Results\n")
                        f.write("=" * 40 + "\n\n")
                        
                        f.write("VIRUS SCAN RESULTS:\n")
                        f.write("-" * 20 + "\n")
                        for result in self.scan_results:
                            f.write(f"File: {result['file_path']}\n")
                            f.write(f"SHA256: {result['hash']}\n")
                            f.write(f"Time: {result['scan_time']}\n")
                            f.write(f"Malicious: {'Yes' if result['is_malicious'] else 'No'}\n")
                            if result['vt_result'] and 'malicious' in result['vt_result']:
                                vt_result = result['vt_result']
                                f.write(f"VirusTotal: {vt_result['malicious_count']}/{vt_result['total_engines']}\n")
                            f.write("\n")
                        
                        f.write("ANDROID APK ANALYSIS:\n")
                        f.write("-" * 22 + "\n")
                        for result in self.analysis_results:
                            f.write(f"App: {result['app_name']} ({result['package_name']})\n")
                            f.write(f"Time: {result['analysis_time']}\n")
                            f.write(f"Suspicious Permissions: {len(result['suspicious_permissions'])}\n")
                            f.write("Permissions:\n")
                            for perm in result['permissions']:
                                f.write(f"  - {perm}\n")
                            f.write("\n")
                
                QMessageBox.information(self, "Export Successful", f"Results exported to:\n{file_path}")
            except Exception as e:
                QMessageBox.critical(self, "Export Error", f"Failed to export results:\n{str(e)}")
    
    def save_settings(self):
        """Save settings"""
        self.virustotal_api_key = self.api_key_input.text().strip()
        self.save_settings_to_file()
        QMessageBox.information(self, "Settings Saved", "Settings have been saved successfully.")
    
    def save_settings_to_file(self):
        """Save settings to file"""
        settings = {
            'virustotal_api_key': self.virustotal_api_key
        }
        try:
            with open('exploitation_settings.json', 'w') as f:
                json.dump(settings, f)
        except Exception as e:
            print(f"Error saving settings: {e}")
    
    def load_settings(self):
        """Load settings from file"""
        try:
            if os.path.exists('exploitation_settings.json'):
                with open('exploitation_settings.json', 'r') as f:
                    settings = json.load(f)
                    self.virustotal_api_key = settings.get('virustotal_api_key', None)
                    if self.virustotal_api_key:
                        self.api_key_input.setText(self.virustotal_api_key)
        except Exception as e:
            print(f"Error loading settings: {e}")

# Ensure the main function is available for standalone execution
def main():
    if not PYQT5_AVAILABLE:
        print("This application requires PyQt5. Please install it with:")
        print("pip install PyQt5")
        sys.exit(1)
    
    from PyQt5.QtWidgets import QApplication
    app = QApplication(sys.argv)
    
    window = ExploitationToolsGUI()
    window.show()
    
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
